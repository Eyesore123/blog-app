import{j as e,q as ce,r as d,b as me,a as ue,e as pe,f as N,J as xe}from"./ConfirmationContext-DK_-GFGj.js";import{a as j}from"./axiosInstance-Hn551h6z.js";import{g as U}from"./Navbar-BhEc0PNi.js";import{Helmet as he}from"react-helmet-async";import fe from"react-markdown";import{S as ge}from"./Spinner4-DhgEGjYq.js";function ye({postUrl:n,postTitle:$}){const y=encodeURIComponent(n),F=encodeURIComponent($);return e.jsxs("div",{className:"gap-2 md:gap-2 !mt-4 flex flex-row justify-center items-center  md:justify-start md:items-start",children:[e.jsx("a",{href:`https://twitter.com/intent/tweet?url=${y}&text=${F}`,target:"_blank",rel:"noopener noreferrer",className:"!px-2 !py-1 bg-black border-1 border-white text-white rounded hover:opacity-80",children:"Share on X"}),e.jsx("a",{href:`https://www.facebook.com/sharer/sharer.php?u=${y}`,target:"_blank",rel:"noopener noreferrer",className:"!px-2 !py-1 bg-blue-700 text-white rounded hover:opacity-80",children:"Share on Facebook"}),e.jsx("a",{href:`https://www.linkedin.com/shareArticle?url=${y}&title=${F}`,target:"_blank",rel:"noopener noreferrer",className:"!px-2 !py-1 bg-[#0A66C2] text-white rounded hover:opacity-80",children:"Share on LinkedIn"}),e.jsx("a",{href:`https://www.reddit.com/submit?url=${y}&title=${F}`,target:"_blank",rel:"noopener noreferrer",className:"!px-2 !py-1 bg-[#FF4500] text-white rounded hover:opacity-80",children:"Share on Reddit"})]})}function Se({post:n,isPostPage:$=!1}){const{auth:y,seo:F}=ce().props,h={...F},a=y.user,D=!!a;a==null||a.token;const L=a?!!a.is_admin:!1,[E,O]=d.useState(!1),[M,v]=d.useState(null),[T,_]=d.useState(""),[be,we]=d.useState(""),[b,w]=d.useState(!1),{showAlert:c}=me(),{confirm:P}=ue(),[m,f]=d.useState([]),[Y,S]=d.useState(null),k=d.useRef(null),[q,H]=d.useState(!0),R=d.useRef(null),C=d.useRef(null),X="https://blog-app-production-16c2.up.railway.app";d.useEffect(()=>{async function t(){try{const o=(await j.get(`api/comments/${n.id}`)).data.map(r=>({...r,createdAt:new Date(r.createdAt).toISOString()}));f(o)}catch(s){console.error("Failed to fetch comments",s)}}t()},[n.id]);const G=async t=>{await P({title:"Delete Post",message:"Are you sure you want to delete this post? This action cannot be undone.",confirmText:"Delete",cancelText:"Cancel",type:"danger"})&&N.delete(`/posts/${t}`,{onSuccess:()=>{console.log(`Post ${t} deleted`),c("Post deleted successfully","success"),N.visit("/")},onError:()=>{c("Failed to delete post","error")}})};async function K(t){if(t.preventDefault(),!C.current||!C.current.value.trim())return;if(!(n!=null&&n.id)){c("Post ID missing","error");return}const s=C.current.value,o={post_id:n.id,content:s,user_id:(a==null?void 0:a.id)||0};w(!0),await U();try{const r=await j.post("/api/comments",o),i={...r.data,user_id:(a==null?void 0:a.id)||0,user:{id:a==null?void 0:a.id,name:a==null?void 0:a.name}};f(u=>[...u,i]),_(r.data.message||"Comment posted successfully"),C.current.value="",setTimeout(()=>{_("")},5e3)}catch(r){console.error("Failed to post comment",r),_("Error posting comment. We apologize for the inconvenience. If you hit the limit of 10 messages per day, please try again tomorrow."),setTimeout(()=>{_("")},5e3)}finally{w(!1)}}const Q=t=>{if($){const s=t.currentTarget;document.fullscreenElement===s?document.exitFullscreen():s.requestFullscreen()}else W()};async function Z(t,s){if(t.preventDefault(),!R.current||!R.current.value.trim())return;const o=R.current.value,r={post_id:n.id,content:o,parent_id:s};w(!0),await U();try{const i=await j.post("/api/comments",r);f([...m,i.data]),v(null)}catch(i){console.error("Failed to post reply",i),c("Error posting reply","error")}finally{w(!1)}}const ee=(t,s)=>{const o=A(t,s),r=V(o,s);return r.length>0&&r.every(i=>i.deleted)},A=(t,s)=>{const o=s.find(r=>r._id===t);return!o||!o.parent_id?t:A(o.parent_id,s)},V=(t,s)=>{const o=[],r=s.find(u=>u._id===t);r&&o.push(r);const i=u=>{s.filter(g=>g.parent_id===u).forEach(g=>{o.push(g),i(g._id)})};return i(t),o},te=async t=>{if(await P({title:"Delete Comment",message:"Are you sure you want to delete this comment?",confirmText:"Delete",cancelText:"Cancel",type:"danger"}))try{const o=await j.delete(`/api/comments/${t}`);console.log(`Comment ${t} deleted`,o.data);const r=m.map(i=>i._id===t?{...i,deleted:!0,content:"[Message removed by moderator]"}:i);if(ee(t,r)){const i=A(t,r),u=V(i,r).map(p=>p._id);f(r.filter(p=>!u.includes(p._id)))}else f(r)}catch(o){console.error("Failed to delete comment",o),o.response&&o.response.status===401?(c("You need to be logged in to delete comments","error"),window.location.href="/login"):c("Error deleting comment. Please try again.","error")}};function W(){n.slug?N.visit(`/post/${n.slug}`):(N.visit(`/post/${n.id}`),console.log("Using post ID for navigation since slug is missing"))}const se=!!(n.image_url&&n.image_url!=="null"&&n.image_url!=="undefined"),ne=t=>m.filter(s=>s.parent_id===t),re=()=>m.filter(t=>!t.parent_id),z=(t,s=0)=>{const r=M===t._id,i=Y===t._id,u=ne(t._id),p=t.deleted,g=!!(a&&t.user_id&&a.id===t.user_id),ae=m.some(l=>l.parent_id===t._id),J=window.innerWidth<768?Math.min(s,3):s,ie=J>0?`!ml-${Math.min(J*4,12)}`:"";async function le(l){if(!k.current||!k.current.value.trim())return;const I=k.current.value;w(!0),await U();try{const B=await j.put(`/api/comments/${l}`,{content:I});f(m.map(x=>x._id===l?{...x,content:I,edited:!0}:x)),S(null),c("Comment updated successfully","success")}catch(B){console.error("Failed to update comment",B),c("Error updating comment. Please try again.","error")}finally{w(!1)}}async function de(l){if(m.some(x=>x.parent_id===l)){c("Cannot delete a comment with replies","warning");return}if(await P({title:"Delete Comment",message:"Are you sure you want to delete your comment?",confirmText:"Delete",cancelText:"Cancel",type:"warning"}))try{await j.delete(`/api/comments/${l}`),f(m.filter(x=>x._id!==l)),c("Your comment has been deleted","success")}catch(x){console.error("Failed to delete comment",x),c("Error deleting comment. Please try again.","error")}}return e.jsxs("div",{className:`bg-[#5800FF]/${10-Math.min(s,5)*2} rounded !p-2 md:!p-3 ${ie}`,children:[e.jsx("p",{className:"font-medium text-xs md:text-sm",children:t.authorName}),p?e.jsx("p",{className:"opacity-60 italic text-xs md:text-sm",children:"[Message removed by moderator]"}):i?e.jsxs("form",{onSubmit:l=>{l.preventDefault(),le(t._id)},className:"!mt-2",children:[e.jsx("textarea",{ref:k,className:"w-full !p-2 h-20 rounded border border-[#5800FF]/20 focus:border-[#5800FF] focus:ring-1 focus:ring-[#5800FF] outline-none text-xs md:text-sm",rows:3,defaultValue:t.content}),e.jsxs("div",{className:"flex gap-2 !mt-1",children:[e.jsx("button",{type:"submit",disabled:b,className:"!px-2 !py-1 md:!px-3 md:!py-1 bg-[#5800FF] text-white rounded hover:bg-[#E900FF] disabled:opacity-50 transition-colors text-[10px] md:text-sm",children:b?"Saving...":"Save Changes"}),e.jsx("button",{type:"button",onClick:()=>S(null),className:"!px-2 !py-1 md:!px-3 md:!py-1 border border-[#5800FF]/20 rounded hover:bg-[#5800FF]/10 text-[10px] md:text-sm",children:"Cancel"})]})]}):e.jsxs("div",{children:[e.jsx("p",{className:"opacity-80 break-words !max-w-full md:!max-w-240 overflow-wrap-anywhere h-auto text-xs md:text-sm",children:t.content}),t.edited&&e.jsx("p",{className:"text-[10px] opacity-60 italic",children:"(edited)"})]}),!i&&e.jsx("p",{className:"text-[10px] md:text-xs opacity-60 italic",children:new Date(t.createdAt).toLocaleString()}),e.jsxs("div",{className:"flex gap-2 !mt-1 md:!mt-2",children:[!p&&s<10&&D&&e.jsx("button",{onClick:()=>{v(t._id),S(null)},className:"text-[10px] md:text-xs text-[#E900FF] hover:underline",children:"Reply"}),!p&&g&&!i&&e.jsx("button",{onClick:()=>{S(t._id),v(null)},className:"text-[10px] text-[#FFC600] md:text-xs hover:underline",children:"Edit"}),!p&&g&&!ae&&e.jsx("button",{onClick:()=>de(t._id),className:"text-red-500 text-[10px] md:text-xs hover:underline",children:"Delete"}),!p&&L&&e.jsx("button",{onClick:()=>te(t._id),className:"text-red-500 text-[10px] md:text-xs hover:underline",children:"Delete (Admin)"})]}),r&&e.jsxs("form",{onSubmit:l=>Z(l,t._id),className:"!mt-2 md:!mt-3",children:[e.jsx("textarea",{ref:R,placeholder:`Reply to ${t.authorName}...`,className:"w-full !p-2 rounded border border-[#5800FF]/20 focus:border-[#5800FF] focus:ring-1 focus:ring-[#5800FF] outline-none text-xs md:text-sm",rows:2,defaultValue:""}),e.jsxs("div",{className:"flex gap-2 !mt-1",children:[e.jsx("button",{type:"submit",disabled:b,className:"!px-2 !py-1 md:!px-3 md:!py-1 bg-[#5800FF] text-white rounded hover:bg-[#E900FF] disabled:opacity-50 transition-colors text-[10px] md:text-sm",children:b?"Posting...":"Post Reply"}),e.jsx("button",{type:"button",onClick:()=>v(null),className:"!px-2 !py-1 md:!px-3 md:!py-1 border border-[#5800FF]/20 rounded hover:bg-[#5800FF]/10 text-[10px] md:text-sm",children:"Cancel"})]})]}),u.length>0&&e.jsx("div",{className:"!mt-2 md:!mt-3 !space-y-2 md:!space-y-3",children:u.map(l=>z(l,s+1))})]},t._id)},oe=`/posts/${n.id}`;return e.jsxs(e.Fragment,{children:[e.jsx(pe,{children:e.jsx("link",{rel:"alternate",type:"application/rss+xml",title:"RSS Feed for Joni's Blog",href:"/feed"})}),e.jsxs(he,{children:[e.jsx("title",{children:h.title}),e.jsx("meta",{name:"description",content:h.description}),e.jsx("meta",{name:"keywords",content:h.keywords||"blog, post"}),e.jsx("meta",{property:"og:title",content:h.title}),e.jsx("meta",{property:"og:description",content:h.description}),e.jsx("meta",{property:"og:image",content:h.image||"/default-image.jpg"}),e.jsx("meta",{property:"og:url",content:h.url})]}),e.jsxs("article",{className:"flex flex-col justify-center items-center lg:items-start lg:justify-start rounded-lg bg-[#5800FF]/5 !p-4 md:!pl-10 w-full md:!w-150 xl:!w-170 2xl:!w-220 !mb-6 md:!mb-10 xl:!ml-0",children:[e.jsx("h2",{className:"text-xl md:text-2xl font-bold flex justify-start !mb-4 md:!mb-10 cursor-pointer hover:underline",onClick:W,children:n.title}),se&&n.image_url&&e.jsxs("div",{className:"relative w-full flex flex-row justify-center items-center lg:justify-start lg:items-start !mb-6 md:!mb-20 !mt-4",style:{width:"100%",maxWidth:"40rem",minHeight:"16rem"},children:[q&&e.jsx("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10",children:e.jsx(ge,{size:64})}),e.jsx("img",{src:`${X}/${n.image_url.replace(/^\/?/,"")}`,alt:n.title,className:"w-full md:w-100 lg:w-150 h-auto cursor-pointer",style:{display:q?"none":"block"},onClick:Q,onLoad:()=>H(!1),onError:t=>{H(!1),console.error("Image failed to load:",n.image_url),t.currentTarget.style.display="none"}})]}),e.jsx(fe,{children:(n.content||"(No content)").replace(/\n/g,`

`),components:{p:({node:t,...s})=>e.jsx("p",{className:"mb-4",...s}),ul:({node:t,...s})=>e.jsx("ul",{className:"list-disc ml-6 mb-4",...s}),ol:({node:t,...s})=>e.jsx("ol",{className:"list-decimal ml-6 mb-4",...s}),li:({node:t,...s})=>e.jsx("li",{className:"mb-2",...s}),strong:({node:t,...s})=>e.jsx("strong",{className:"font-bold",...s}),em:({node:t,...s})=>e.jsx("em",{className:"italic",...s}),blockquote:({node:t,...s})=>e.jsx("blockquote",{className:"border-l-4 border-gray-300 pl-4 italic text-gray-600 mb-4",...s}),code:({inline:t,...s})=>t?e.jsx("code",{className:"bg-gray-100 text-red-500 px-1 rounded",...s}):e.jsx("pre",{className:"bg-gray-100 p-2 rounded overflow-x-auto",children:e.jsx("code",{...s})})},skipHtml:!1}),e.jsxs("div",{className:"text-xs md:text-sm flex flex-col justify-center items-center  md:justify-start md:items-start text-gray-500 !mt-3 !pt-4 md:!pt-6 !space-y-1 border-t border-[#5800FF]/20",children:[n.created_at&&e.jsxs("div",{children:["Created: ",new Date(n.created_at).toLocaleString()]}),n.updated_at&&n.updated_at!==n.created_at&&e.jsxs("div",{className:"italic",children:["Updated: ",new Date(n.updated_at).toLocaleString()]}),n.tags&&n.tags.length>0&&e.jsx("div",{className:"!mt-4 flex flex-wrap gap-2",children:n.tags.map(t=>e.jsxs("span",{className:"bg-[#5800FF]/20 text-[#5800FF] text-xs md:text-sm !px-2 !py-1 rounded cursor-pointer hover:bg-[#5800FF]/40",onClick:()=>{N.get(`/posts/tag/${encodeURIComponent(t.name)}`)},children:["#",t.name]},t.id))}),e.jsx(ye,{postUrl:oe,postTitle:n.title}),L&&e.jsx("button",{onClick:()=>G(n.id),className:"right-4 md:top-10 md:right-30 !px-3 !py-1 bg-red-600 text-white rounded hover:bg-red-800 transition-colors !mt-4",children:"Delete"})]}),e.jsxs("div",{className:"!mt-4 md:!mt-6 !pt-4 md:!pt-6 border-t border-[#5800FF]/20 w-full",children:[e.jsx("button",{onClick:()=>O(!E),className:"text-xs md:text-sm opacity-70 hover:opacity-100 transition-opacity",children:E?"Hide Comments":`Show Comments (${m.length})`}),E&&e.jsxs("div",{className:"!mt-3 md:!mt-4 !space-y-3 md:!space-y-4 w-full",children:[m.length>0?re().map(t=>z(t)):e.jsx("p",{className:"text-xs md:text-sm opacity-60 italic",children:"No comments yet. Be the first!"}),D&&M===null&&e.jsxs("form",{onSubmit:K,className:"!mt-4 md:!mt-6",children:[e.jsx("textarea",{ref:C,placeholder:"Write a comment...",className:"w-full !p-2 rounded border border-[#5800FF]/20 focus:border-[#5800FF] focus:ring-1 focus:ring-[#5800FF] outline-none text-sm md:text-base",rows:3,defaultValue:""}),e.jsx("button",{type:"submit",disabled:b,className:"!mt-2 !px-3 !py-1 md:!px-4 md:!py-2 bg-[#5800FF] text-white rounded hover:bg-[#E900FF] disabled:opacity-50 transition-colors text-sm md:text-base",children:b?"Posting...":"Post Comment"})]}),T&&e.jsx("div",{className:`message ${T.includes("Error")?"error":"success"} !p-2 rounded-md !mt-2 w-auto`,style:{transition:"opacity 0.5s ease-in-out"},children:T}),!D&&e.jsxs("p",{className:"text-xs md:text-sm !mt-2 md:!mt-4",children:[e.jsx(xe,{href:"/login",className:"text-[#5800FF] hover:underline",children:"Sign in"})," ","to leave a comment."]})]})]})]})]})}export{Se as B};
